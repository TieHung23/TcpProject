@model ChatModel


<div class="container py-4" style="max-width: 600px;">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <span>
                <i class="bi bi-chat-dots"></i>
                TCP Chat
            </span>
            <small>Connected as <b>@Model.UserName</b> to <span class="text-warning">@Model.Ip:@Model.Port</span></small>
        </div>
        <div id="messages" class="card-body bg-light" style="height: 350px; overflow-y: auto;">
            @foreach (var msg in Model.Messages)
            {
                var isOwn = msg.StartsWith($"{Model.UserName}:");
                <div class="mb-2 d-flex @(isOwn ? "justify-content-end" : "justify-content-start")">
                    <div class="p-2 rounded-3 @(isOwn ? "bg-success text-white" : "bg-white border")" style="max-width: 75%;">
                        @msg
                    </div>
                </div>
            }
        </div>
        <div class="card-footer bg-white">
            <form method="post" asp-action="SendMessage" asp-controller="Chat" class="d-flex gap-2">
                <input type="text" name="message" class="form-control" placeholder="Type a message..." autocomplete="off" />
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-send"></i> Send
                </button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script>
        function fetchMessages() {
            fetch('/Chat/GetMessages')
                .then(response => response.json())
                .then(data => {
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = '';
                    const userName = '@Model.UserName:';
                    data.forEach(msg => {
                        const isOwn = msg.startsWith(userName);
                        const wrapper = document.createElement('div');
                        wrapper.className = 'mb-2 d-flex ' + (isOwn ? 'justify-content-end' : 'justify-content-start');
                        const bubble = document.createElement('div');
                        bubble.className = 'p-2 rounded-3 ' + (isOwn ? 'bg-success text-white' : 'bg-white border');
                        bubble.style.maxWidth = '75%';
                        bubble.textContent = msg;
                        wrapper.appendChild(bubble);
                        messagesDiv.appendChild(wrapper);
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                });
        }
        setInterval(fetchMessages, 1000);
        fetchMessages();
    </script>
}
